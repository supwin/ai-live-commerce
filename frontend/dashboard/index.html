<!--frontend/dashboard/index.html-->

<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Live Commerce - Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4A90E2;
            --secondary-color: #00ff88;
            --accent-color: #ff6b6b;
            --warning-color: #ffeb3b;
            --text-primary: #333333;
            --text-secondary: #666666;
            --background-light: #f8f9fa;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --error-color: #dc3545;
            --info-color: #17a2b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background-light);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid var(--border-color);
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .sidebar-header h1 {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .sidebar-header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-item {
            display: block;
            padding: 12px 20px;
            color: var(--text-primary);
            text-decoration: none;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-item:hover,
        .nav-item.active {
            background: var(--primary-color);
            color: white;
        }

        .nav-item i {
            margin-right: 10px;
            width: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
        }

        .page-header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .page-subtitle {
            color: var(--text-secondary);
            margin-top: 5px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary-color);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card.success {
            border-left-color: var(--success-color);
        }

        .stat-card.warning {
            border-left-color: var(--warning-color);
        }

        .stat-card.info {
            border-left-color: var(--info-color);
        }

        .stat-card .stat-icon {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .stat-card .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .stat-card .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Content Sections */
        .content-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .section-actions {
            display: flex;
            gap: 10px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #357abd;
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: var(--text-primary);
        }

        .btn-danger {
            background: var(--error-color);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        /* Product Cards */
        .products-grid {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .product-card:hover {
            transform: translateY(-2px);
        }

        .product-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .product-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .product-sku {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .product-info {
            padding: 15px;
        }

        .product-price {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--success-color);
            margin-bottom: 10px;
        }

        .product-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .product-actions {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-processing {
            background: #fff3cd;
            color: #856404;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading i {
            font-size: 2rem;
            margin-bottom: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-actions {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Filters */
        .filters-section {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: #f8f9fa;
        }

        .filters-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }

        .filter-group label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .products-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Utilities */
        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-10 {
            margin-top: 10px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .d-flex {
            display: flex;
        }

        .justify-between {
            justify-content: space-between;
        }

        .align-center {
            align-items: center;
        }

        .gap-10 {
            gap: 10px;
        }

        /* Alert Messages */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid;
        }

        .alert-success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-robot"></i> AI Live Commerce</h1>
                <p>Dashboard Control Panel</p>
            </div>
            <nav class="sidebar-nav">
                <a class="nav-item active" data-section="overview">
                    <i class="fas fa-chart-line"></i> Overview
                </a>
                <a class="nav-item" data-section="products">
                    <i class="fas fa-box"></i> Products
                </a>
                <a class="nav-item" data-section="scripts">
                    <i class="fas fa-script"></i> Scripts
                </a>
                <a class="nav-item" data-section="mp3">
                    <i class="fas fa-music"></i> MP3 Files
                </a>
                <a class="nav-item" data-section="videos">
                    <i class="fas fa-video"></i> Videos
                </a>
                <a class="nav-item" data-section="personas">
                    <i class="fas fa-users"></i> Personas
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Page Header -->
            <div class="page-header">
                <div>
                    <h1 class="page-title">AI Live Commerce Dashboard</h1>
                    <p class="page-subtitle">จัดการสินค้า สร้างสคริปต์ และเตรียมความพร้อมสำหรับ Live Streaming</p>
                </div>
                <button class="btn btn-primary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>

            <!-- Alert Messages Container -->
            <div id="alert-container"></div>

            <!-- Overview Section -->
            <div class="content-section active" id="overview-section">
                <!-- Stats Cards -->
                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-number" id="total-products">-</div>
                        <div class="stat-label">Total Products</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-number" id="active-products">-</div>
                        <div class="stat-label">Active Products</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-icon">
                            <i class="fas fa-script"></i>
                        </div>
                        <div class="stat-number" id="total-scripts">-</div>
                        <div class="stat-label">Total Scripts</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-icon">
                            <i class="fas fa-music"></i>
                        </div>
                        <div class="stat-number" id="total-mp3s">-</div>
                        <div class="stat-label">MP3 Files</div>
                    </div>
                </div>
            </div>

            <!-- Products Section -->
            <div class="content-section" id="products-section">
                <div class="section-header">
                    <h2 class="section-title">Products Management</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="showCreateProductModal()">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                        <button class="btn btn-secondary" onclick="loadProducts()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="filters-section">
                    <div class="filters-row">
                        <div class="filter-group">
                            <label>Category</label>
                            <select class="form-control" id="category-filter" onchange="loadProducts()">
                                <option value="">All Categories</option>
                                <option value="electronics">Electronics</option>
                                <option value="fashion">Fashion</option>
                                <option value="beauty">Beauty</option>
                                <option value="home">Home & Living</option>
                                <option value="sports">Sports</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Status</label>
                            <select class="form-control" id="status-filter" onchange="loadProducts()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="out_of_stock">Out of Stock</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Search</label>
                            <input type="text" class="form-control" placeholder="Search products..."
                                id="search-products" onkeyup="searchProducts()">
                        </div>
                    </div>
                </div>

                <div class="products-grid" id="products-grid">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading products...</p>
                    </div>
                </div>
            </div>

            <!-- Scripts Section -->
            <div class="content-section" id="scripts-section">
                <div class="section-header">
                    <h2 class="section-title">Scripts Management</h2>
                    <div class="section-actions">
                        <select class="form-control" style="width: auto;" id="scripts-product-filter"
                            onchange="loadScripts()">
                            <option value="">Select Product</option>
                        </select>
                        <button class="btn btn-secondary" onclick="loadScripts()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div id="scripts-content">
                    <div class="loading">
                        <i class="fas fa-info-circle"></i>
                        <p>Select a product to view scripts...</p>
                    </div>
                </div>
            </div>

            <div class="content-section" id="mp3-section">
                <div class="section-header">
                    <h2 class="section-title">MP3 Files</h2>
                </div>
                <div class="loading">
                    <i class="fas fa-tools"></i>
                    <p>MP3 management coming soon...</p>
                </div>
            </div>

            <div class="content-section" id="videos-section">
                <div class="section-header">
                    <h2 class="section-title">Videos</h2>
                </div>
                <div class="loading">
                    <i class="fas fa-tools"></i>
                    <p>Video management coming soon...</p>
                </div>
            </div>

            <div class="content-section" id="personas-section">
                <div class="section-header">
                    <h2 class="section-title">Personas</h2>
                </div>
                <div class="loading">
                    <i class="fas fa-tools"></i>
                    <p>Persona management coming soon...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Container -->
    <div id="modal-container"></div>

    <script>
        // Global Variables
        let currentProducts = [];
        let filteredProducts = [];
        let currentScripts = [];
        let scriptPersonas = [];
        let voicePersonas = [];

        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', function () {
            initializeDashboard();
        });

        async function initializeDashboard() {
            console.log('🚀 Initializing AI Live Commerce Dashboard...');

            // Setup navigation
            setupNavigation();

            // Load initial data
            await Promise.all([
                loadDashboardStats(),
                loadProducts(),
                loadPersonas()
            ]);

            console.log('✅ Dashboard initialized successfully');
        }

        function setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            const contentSections = document.querySelectorAll('.content-section');

            navItems.forEach(item => {
                item.addEventListener('click', function (e) {
                    e.preventDefault();

                    const targetSection = this.getAttribute('data-section');

                    // Update active nav item
                    navItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');

                    // Update active content section
                    contentSections.forEach(section => section.classList.remove('active'));
                    document.getElementById(targetSection + '-section').classList.add('active');

                    // Load section-specific data
                    loadSectionData(targetSection);
                });
            });
        }

        async function loadSectionData(section) {
            switch (section) {
                case 'overview':
                    await loadDashboardStats();
                    break;
                case 'products':
                    await loadProducts();
                    break;
                case 'scripts':
                    await loadProductsForScriptsFilter();
                    break;
            }
        }

        // Load personas
        async function loadPersonas() {
            try {
                const [scriptResponse, voiceResponse] = await Promise.all([
                    fetch('/api/v1/dashboard/personas/script'),
                    fetch('/api/v1/dashboard/personas/voice')
                ]);

                if (scriptResponse.ok) {
                    scriptPersonas = await scriptResponse.json();
                }
                if (voiceResponse.ok) {
                    voicePersonas = await voiceResponse.json();
                }

            } catch (error) {
                console.error('Error loading personas:', error);
            }
        }

        // AI Script Generation
        function showAIScriptGenerationModal(productId) {
            const product = currentProducts.find(p => p.id === productId);

            if (!scriptPersonas.length) {
                showAlert('No script personas available. Please create script personas first.', 'error');
                return;
            }

            const modal = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>🤖 Generate AI Scripts for ${escapeHtml(product.name)}</h3>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Script Persona:</label>
                                <select class="form-control" id="script-persona-select">
                                    ${scriptPersonas.map(persona =>
                `<option value="${persona.id}">${escapeHtml(persona.name)} - ${escapeHtml(persona.description || persona.speaking_style || '')}</option>`
            ).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Mood/Emotion:</label>
                                <select class="form-control" id="script-mood-select">
                                    <option value="auto">Auto (Let AI decide)</option>
                                    <option value="excited">😄 Excited - ตื่นเต้น กระตือรือร้น</option>
                                    <option value="professional">👔 Professional - มืออาชีพ เป็นทางการ</option>
                                    <option value="friendly">😊 Friendly - เป็นกันเอง อบอุ่น</option>
                                    <option value="confident">💪 Confident - มั่นใจ เชื่อมั่น</option>
                                    <option value="energetic">⚡ Energetic - มีพลัง เร่าร้อน</option>
                                    <option value="calm">😌 Calm - สงบ ใจเย็น</option>
                                    <option value="urgent">⏰ Urgent - เร่งด่วน จำกัดเวลา</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Number of Scripts:</label>
                                <select class="form-control" id="script-count-select">
                                    <option value="3">3 Scripts (Recommended)</option>
                                    <option value="5">5 Scripts</option>
                                    <option value="1">1 Script</option>
                                </select>
                            </div>
                            <div class="alert alert-info">
                                <strong>🎭 Emotional TTS:</strong> Scripts will include emotional markup tags for TTS to express the right mood and feeling.
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="executeAIScriptGeneration(${productId})">
                                <i class="fas fa-robot"></i> Generate Scripts
                            </button>
                        </div>
                    </div>
                </div>
            `;

            showModal(modal);
        }

        async function executeAIScriptGeneration(productId) {
            const personaId = document.getElementById('script-persona-select').value;
            const mood = document.getElementById('script-mood-select').value;
            const count = parseInt(document.getElementById('script-count-select').value);

            if (!personaId) {
                showAlert('Please select a script persona', 'error');
                return;
            }

            try {
                showAlert('กำลังสร้าง AI scripts พร้อม emotional markup...', 'info');
                closeModal();

                const response = await fetch('/api/v1/dashboard/scripts/generate-ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        product_id: parseInt(productId),
                        persona_id: parseInt(personaId),
                        mood: mood,
                        count: count
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showAlert(`สร้าง ${result.scripts.length} AI scripts พร้อม emotional markup สำเร็จ!`, 'success');

                    // อัพเดทข้อมูล scripts ใน memory
                    currentScripts = result.scripts;

                    // Switch to scripts section และแสดงผล
                    switchToScriptsSection(productId);

                    // รีโหลด products stats ด้วย
                    await loadDashboardStats();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to generate scripts');
                }

            } catch (error) {
                console.error('Error generating AI scripts:', error);
                showAlert('Failed to generate AI scripts: ' + error.message, 'error');
            }
        }

        async function switchToScriptsSection(productId) {
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            document.querySelector('[data-section="scripts"]').classList.add('active');

            // Update content sections
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
            document.getElementById('scripts-section').classList.add('active');

            // Set product filter และโหลด scripts ใหม่จาก API
            document.getElementById('scripts-product-filter').value = productId;

            // รีโหลด scripts จาก API เพื่อให้แน่ใจว่าได้ข้อมูลล่าสุด
            await loadScripts();
        }

        // Scripts Management
        async function loadProductsForScriptsFilter() {
            try {
                console.log('🔄 Loading products for scripts filter...');

                const response = await fetch('/api/v1/dashboard/products');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('📦 Products API Response:', data);

                // ดึง products array จาก response object
                const products = data.products || [];
                console.log('📋 Products array:', products);

                const select = document.getElementById('scripts-product-filter');

                if (!select) {
                    console.error('❌ scripts-product-filter element not found');
                    return;
                }

                select.innerHTML = '<option value="">Select Product</option>' +
                    products.map(product =>
                        `<option value="${product.id}">${escapeHtml(product.name)} (${escapeHtml(product.sku)})</option>`
                    ).join('');

                console.log(`✅ Loaded ${products.length} products for filter`);
            } catch (error) {
                console.error('❌ Error loading products for filter:', error);

                // แสดง error ใน select dropdown
                const select = document.getElementById('scripts-product-filter');
                if (select) {
                    select.innerHTML = '<option value="">Error loading products</option>';
                }

                showAlert('ไม่สามารถโหลดรายการสินค้าได้: ' + error.message, 'error');
            }
        }

        async function loadScripts() {
            const productId = document.getElementById('scripts-product-filter').value;
            const contentDiv = document.getElementById('scripts-content');

            if (!productId) {
                contentDiv.innerHTML = '<div class="loading"><i class="fas fa-info-circle"></i><p>Select a product to view scripts...</p></div>';
                return;
            }

            try {
                const response = await fetch(`/api/v1/dashboard/products/${productId}/scripts`);
                currentScripts = await response.json();

                displayScripts(productId);

            } catch (error) {
                console.error('Error loading scripts:', error);

                // แสดง error ที่ละเอียดขึ้น
                const contentDiv = document.getElementById('scripts-content');
                contentDiv.innerHTML = `
                    <div class="alert alert-error" style="margin: 20px;">
                        <h4>⚠️ ไม่สามารถโหลด scripts ได้</h4>
                        <p>Error: ${error.message}</p>
                        <button class="btn btn-primary" onclick="loadScripts()">🔄 ลองใหม่</button>
                    </div>
                `;

                showAlert('ไม่สามารถโหลด scripts ได้: ' + error.message, 'error');
            }
        }

        function displayScripts(productId) {
            const product = currentProducts.find(p => p.id == productId);
            const contentDiv = document.getElementById('scripts-content');

            console.log('📄 Displaying scripts for product:', productId);
            console.log('📊 Scripts count:', currentScripts.length);
            console.log('🔍 Scripts data:', currentScripts);

            // Count scripts without MP3
            const scriptsWithoutMP3 = currentScripts.filter(s => !s.has_mp3);
            const scriptsWithMP3 = currentScripts.filter(s => s.has_mp3);

            contentDiv.innerHTML = `
                <div class="section-header" style="border-bottom: 1px solid var(--border-color);">
                    <h3>📝 Scripts for ${product ? escapeHtml(product.name) : 'Selected Product'}</h3>
                    <div class="section-actions">
                        <button class="btn btn-primary btn-sm" onclick="showCreateManualScriptModal(${productId})">
                            <i class="fas fa-plus"></i> Manual Script
                        </button>
                        <button class="btn btn-success btn-sm" onclick="showAIScriptGenerationModal(${productId})">
                            <i class="fas fa-robot"></i> AI Scripts
                        </button>
                        ${scriptsWithoutMP3.length > 0 ? `
                            <button class="btn btn-warning btn-sm" onclick="showBulkMP3GenerationModal(${productId})">
                                <i class="fas fa-music"></i> Bulk MP3 (${scriptsWithoutMP3.length})
                            </button>
                        ` : ''}
                    </div>
                </div>
                <div class="scripts-list" style="padding: 20px;">
                    ${currentScripts.length > 0 ? `
                        <div class="scripts-summary" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>📊 Summary:</strong> 
                                    ${currentScripts.length} scripts total | 
                                    <span style="color: var(--success-color);">✅ ${scriptsWithMP3.length} with MP3</span> | 
                                    <span style="color: var(--warning-color);">📝 ${scriptsWithoutMP3.length} pending MP3</span>
                                </div>
                                ${scriptsWithoutMP3.length > 1 ? `
                                    <button class="btn btn-sm btn-success" onclick="showBulkMP3GenerationModal(${productId})">
                                        <i class="fas fa-music"></i> Generate All MP3s
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        ${currentScripts.map(script => createScriptCard(script)).join('')}
                    ` : `
                        <div class="text-center" style="padding: 40px;">
                            <i class="fas fa-script" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 15px;"></i>
                            <h3>No scripts found</h3>
                            <p>Generate some AI scripts to get started!</p>
                            <button class="btn btn-primary mt-10" onclick="showAIScriptGenerationModal(${productId})">
                                <i class="fas fa-robot"></i> Generate AI Scripts
                            </button>
                        </div>
                    `}
                </div>
            `;
        }

        function createScriptCard(script) {
            // Convert emotional markup to styled display
            const displayContent = formatEmotionalMarkup(script.content);

            // Determine card border color based on MP3 status
            const borderColor = script.has_mp3 ? 'var(--success-color)' : 'var(--primary-color)';

            return `
                <div class="script-card" style="background: white; border-radius: 8px; margin-bottom: 20px; padding: 20px; border-left: 4px solid ${borderColor}; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div class="script-header" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <h4 style="margin: 0; flex: 1;">${escapeHtml(script.title)}</h4>
                            <div style="text-align: right;">
                                ${script.has_mp3 ?
                    '<span class="status-badge status-completed" style="background: #d4edda; color: #155724;"><i class="fas fa-music"></i> MP3 Ready</span>' :
                    '<span class="status-badge status-processing" style="background: #fff3cd; color: #856404;"><i class="fas fa-clock"></i> Script Only</span>'
                }
                            </div>
                        </div>
                        <div class="d-flex gap-10 align-center" style="flex-wrap: wrap;">
                            <span class="status-badge status-info">${script.script_type}</span>
                            ${script.persona_name ? `<span class="status-badge status-active">👤 ${escapeHtml(script.persona_name)}</span>` : ''}
                            ${script.target_emotion ? `<span class="status-badge" style="background: #e3f2fd; color: #1976d2;">🎭 ${script.target_emotion}</span>` : ''}
                            ${script.duration_estimate ? `<span class="text-secondary">⏱️ ~${script.duration_estimate}s</span>` : ''}
                            ${script.word_count ? `<span class="text-secondary">📝 ${script.word_count} words</span>` : ''}
                        </div>
                    </div>
                    <div class="script-content" style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px; max-height: 300px; overflow-y: auto; line-height: 1.6;">
                        ${displayContent}
                    </div>
                    <div class="script-actions" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        ${script.has_mp3 ? `
                            <!-- MP3 Available Actions -->
                            <button class="btn btn-success btn-sm" onclick="playMP3(${script.id})" title="Play MP3 audio">
                                <i class="fas fa-play"></i> Play
                            </button>
                            <button class="btn btn-info btn-sm" onclick="downloadMP3(${script.id})" title="Download MP3 file">
                                <i class="fas fa-download"></i> Download
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="viewScriptDetails(${script.id})" title="View script details">
                                <i class="fas fa-eye"></i> Details
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteMP3(${script.id})" title="Delete MP3 and unlock script">
                                <i class="fas fa-trash"></i> Delete MP3
                            </button>
                        ` : `
                            <!-- No MP3 Actions -->
                            <button class="btn btn-success btn-sm" onclick="generateMP3ForScript(${script.id})" title="Generate MP3 from this script">
                                <i class="fas fa-music"></i> Create MP3
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="editScript(${script.id})" ${!script.can_edit ? 'disabled' : ''} title="${script.can_edit ? 'Edit script content' : 'Script locked - has MP3 files'}">
                                <i class="fas fa-edit"></i> ${script.can_edit ? 'Edit' : 'Locked'}
                            </button>
                            <button class="btn btn-info btn-sm" onclick="viewScriptDetails(${script.id})" title="View script details">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                        `}
                        <button class="btn btn-danger btn-sm" onclick="deleteScript(${script.id}, '${escapeHtml(script.title)}')" title="Delete script and all MP3 files">
                            <i class="fas fa-trash"></i> Delete Script
                        </button>
                    </div>
                    ${script.has_mp3 ? `
                        <div class="mp3-info" style="background: #e8f5e8; padding: 10px; border-radius: 6px; margin-top: 15px; font-size: 0.9rem;">
                            <strong>🎵 MP3 Information:</strong><br>
                            <span class="text-secondary">
                                📁 Ready for live streaming | 
                                🔒 Script is locked (delete MP3 to edit) |
                                ⏱️ Est. duration: ${script.duration_estimate || 'Unknown'}s
                            </span>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        async function downloadMP3(scriptId) {
            try {
                // Check if script has MP3
                const response = await fetch(`/api/v1/dashboard/scripts/${scriptId}`);
                if (!response.ok) {
                    throw new Error('Script not found');
                }

                const script = await response.json();

                if (!script.has_mp3) {
                    showAlert('This script does not have an MP3 file yet.', 'warning');
                    return;
                }

                // Create download link
                const downloadUrl = `/static/audio/script_${scriptId}.mp3`;
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `${script.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.mp3`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showAlert('🎵 MP3 download started!', 'success');

            } catch (error) {
                console.error('Error downloading MP3:', error);
                showAlert('Error downloading MP3 file: ' + error.message, 'error');
            }
        }

        function formatEmotionalMarkup(content) {
            // Convert emotional markup to styled HTML
            let formatted = escapeHtml(content);

            // Define emotion colors and styles
            const emotionStyles = {
                'excited': 'color: #ff6b35; font-weight: bold;',
                'happy': 'color: #4ecdc4; font-weight: bold;',
                'professional': 'color: #2c5aa0; font-weight: 500;',
                'confident': 'color: #8e44ad; font-weight: bold;',
                'energetic': 'color: #e74c3c; font-weight: bold;',
                'calm': 'color: #27ae60; font-style: italic;',
                'warm': 'color: #f39c12; font-weight: 500;',
                'friendly': 'color: #16a085; font-weight: 500;',
                'trustworthy': 'color: #34495e; font-weight: 500;',
                'urgent': 'color: #e74c3c; font-weight: bold; text-decoration: underline;'
            };

            // Replace emotional markup with styled spans
            Object.keys(emotionStyles).forEach(emotion => {
                const openTag = `{${emotion}}`;
                const closeTag = `{/${emotion}}`;
                const style = emotionStyles[emotion];

                const regex = new RegExp(`\\{${emotion}\\}(.*?)\\{\\/${emotion}\\}`, 'g');
                formatted = formatted.replace(regex, `<span style="${style}" title="Emotion: ${emotion}">$1</span>`);
            });

            // Convert line breaks
            formatted = formatted.replace(/\\n/g, '<br>');

            return formatted;
        }

        // Add product card action for AI script generation
        function addAIScriptButton(productId) {
            return `<button class="btn btn-success btn-sm" onclick="showAIScriptGenerationModal(${productId})">
                        <i class="fas fa-robot"></i> AI Scripts
                    </button>`;
        }

        // Placeholder functions for script actions
        async function viewScriptDetails(scriptId) {
            try {
                const response = await fetch(`/api/v1/dashboard/scripts/${scriptId}`);
                if (!response.ok) {
                    throw new Error('Script not found');
                }

                const script = await response.json();

                const modal = `
                    <div class="modal-overlay" onclick="closeModal()">
                        <div class="modal-content" onclick="event.stopPropagation()">
                            <div class="modal-header">
                                <h3>📝 Script Details: ${escapeHtml(script.title)}</h3>
                                <button class="modal-close" onclick="closeModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <strong>📊 Script Information:</strong>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 10px;">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                            <div>
                                                <strong>Type:</strong> ${script.script_type}<br>
                                                <strong>Language:</strong> ${script.language || 'th'}<br>
                                                <strong>Status:</strong> ${script.status}
                                            </div>
                                            <div>
                                                <strong>Words:</strong> ${script.word_count || 0}<br>
                                                <strong>Duration:</strong> ~${script.duration_estimate || 0}s<br>
                                                <strong>Has MP3:</strong> ${script.has_mp3 ? '✅ Yes' : '❌ No'}
                                            </div>
                                        </div>
                                        ${script.persona_name ? `<strong>Persona:</strong> ${escapeHtml(script.persona_name)}<br>` : ''}
                                        ${script.target_emotion ? `<strong>Emotion:</strong> ${script.target_emotion}<br>` : ''}
                                        ${script.call_to_action ? `<strong>Call to Action:</strong> ${escapeHtml(script.call_to_action)}<br>` : ''}
                                    </div>
                                </div>
                                <div class="form-group">
                                    <strong>📄 Script Content:</strong>
                                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 10px; max-height: 300px; overflow-y: auto; line-height: 1.6;">
                                        ${formatEmotionalMarkup(script.content)}
                                    </div>
                                </div>
                                ${script.has_mp3 ? `
                                    <div class="form-group">
                                        <strong>🎵 MP3 Status:</strong>
                                        <div style="background: #e8f5e8; padding: 15px; border-radius: 6px; margin-top: 10px;">
                                            ✅ MP3 file is ready for use<br>
                                            🔒 Script editing is locked<br>
                                            📁 File available for download and playback
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="modal-actions">
                                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                                ${script.can_edit ? `
                                    <button class="btn btn-primary" onclick="closeModal(); editScript(${script.id})">
                                        <i class="fas fa-edit"></i> Edit Script
                                    </button>
                                ` : ''}
                                ${!script.has_mp3 ? `
                                    <button class="btn btn-success" onclick="closeModal(); generateMP3ForScript(${script.id})">
                                        <i class="fas fa-music"></i> Generate MP3
                                    </button>
                                ` : `
                                    <button class="btn btn-success" onclick="closeModal(); playMP3(${script.id})">
                                        <i class="fas fa-play"></i> Play MP3
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                `;

                showModal(modal);

            } catch (error) {
                console.error('Error loading script details:', error);
                showAlert('Failed to load script details: ' + error.message, 'error');
            }
        }

        async function editScript(scriptId) {
            const script = currentScripts.find(s => s.id === scriptId);
            if (!script) return;

            if (!script.can_edit) {
                showAlert('ไม่สามารถแก้ไขสคริปต์ได้ เนื่องจากมี MP3 ผูกอยู่', 'warning');
                return;
            }

            const modal = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>แก้ไขสคริปต์: ${escapeHtml(script.title)}</h3>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>ชื่อสคริปต์:</label>
                                <input type="text" class="form-control" id="edit-script-title" value="${escapeHtml(script.title)}">
                            </div>
                            <div class="form-group">
                                <label>เนื้อหาสคริปต์:</label>
                                <textarea class="form-control" id="edit-script-content" rows="10">${escapeHtml(script.content)}</textarea>
                            </div>
                            <div class="form-group">
                                <label>อารมณ์:</label>
                                <select class="form-control" id="edit-script-emotion">
                                    <option value="professional" ${script.target_emotion === 'professional' ? 'selected' : ''}>มืออาชีพ</option>
                                    <option value="friendly" ${script.target_emotion === 'friendly' ? 'selected' : ''}>เป็นมิตร</option>
                                    <option value="excited" ${script.target_emotion === 'excited' ? 'selected' : ''}>ตื่นเต้น</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeModal()">ยกเลิก</button>
                            <button class="btn btn-primary" onclick="confirmUpdateScript(${scriptId})">
                                <i class="fas fa-save"></i> บันทึก
                            </button>
                        </div>
                    </div>
                </div>
            `;
            showModal(modal);
        }

        async function confirmUpdateScript(scriptId) {
            if (!confirm('คุณต้องการบันทึกการแก้ไขสคริปต์นี้หรือไม่?')) return;

            const updateData = {
                title: document.getElementById('edit-script-title').value,
                content: document.getElementById('edit-script-content').value,
                target_emotion: document.getElementById('edit-script-emotion').value
            };

            try {
                const response = await fetch(`/api/v1/dashboard/scripts/${scriptId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    showAlert('บันทึกการแก้ไขสคริปต์สำเร็จ!', 'success');
                    closeModal();
                    await loadScripts(); // Reload scripts
                } else {
                    throw new Error('Failed to update script');
                }
            } catch (error) {
                showAlert('ไม่สามารถบันทึกการแก้ไขได้: ' + error.message, 'error');
            }
        }

        async function deleteScript(scriptId, title) {
            if (!confirm(`คุณต้องการลบสคริปต์ "${title}" หรือไม่?\n\nการลบจะส่งผลให้ MP3 ที่เกี่ยวข้องถูกลบด้วย`)) {
                return;
            }

            try {
                const response = await fetch(`/api/v1/dashboard/scripts/${scriptId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const result = await response.json();
                    showAlert(`ลบสคริปต์ "${title}" สำเร็จ!`, 'success');
                    await loadScripts(); // Reload scripts
                    await loadDashboardStats(); // Update stats
                } else {
                    throw new Error('Failed to delete script');
                }
            } catch (error) {
                showAlert('ไม่สามารถลบสคริปต์ได้: ' + error.message, 'error');
            }
        }

        async function generateMP3ForScript(scriptId) {
            const script = currentScripts.find(s => s.id === scriptId);
            if (!script) {
                showAlert('Script not found', 'error');
                return;
            }

            if (!voicePersonas.length) {
                showAlert('No voice personas available. Please create voice personas first.', 'error');
                return;
            }

            // ดึงข้อมูล TTS providers
            try {
                const providersResponse = await fetch('/api/v1/dashboard/tts/providers');
                const providersData = await providersResponse.json();

                const modal = `
                    <div class="modal-overlay" onclick="closeModal()">
                        <div class="modal-content" onclick="event.stopPropagation()">
                            <div class="modal-header">
                                <h3>🎵 Enhanced MP3 Generation for: ${escapeHtml(script.title)}</h3>
                                <button class="modal-close" onclick="closeModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <label class="form-label">Voice Persona:</label>
                                    <select class="form-control" id="voice-persona-select" onchange="updateEmotionOptions()">
                                        ${voicePersonas.map(persona => {
                    const provider = persona.tts_provider || 'basic';
                    const providerLabel = provider === 'edge' ? '🎭 Enhanced' :
                        provider === 'elevenlabs' ? '🤖 Premium AI' :
                            provider === 'azure' ? '🏢 Enterprise' : '📢 Basic';
                    const premiumLabel = persona.is_premium ? ' 💎' : '';

                    return `<option value="${persona.id}" data-provider="${provider}" data-emotions='${JSON.stringify(persona.emotional_range || [])}'>
                                                ${providerLabel} ${escapeHtml(persona.name)}${premiumLabel}
                                            </option>`;
                }).join('')}
                                    </select>
                                    <small class="text-secondary">
                                        Enhanced voices support emotional expressions and natural speech patterns
                                    </small>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Emotion & Mood:</label>
                                    <select class="form-control" id="emotion-select">
                                        <option value="professional">🎯 Professional - มืออาชีพ เป็นทางการ</option>
                                        <option value="friendly">😊 Friendly - เป็นมิตร อบอุ่น</option>
                                        <option value="excited">🔥 Excited - ตื่นเต้น กระตือรือร้น</option>
                                        <option value="confident">💪 Confident - มั่นใจ แน่วแน่</option>
                                        <option value="energetic">⚡ Energetic - มีพลัง เร่าร้อน</option>
                                        <option value="calm">😌 Calm - สงบ ใจเย็น</option>
                                        <option value="cheerful">🎉 Cheerful - ร่าเริง สนุกสนาน</option>
                                        <option value="gentle">🌸 Gentle - อ่อนโยน นุ่มนวล</option>
                                        <option value="serious">🎖️ Serious - จริงจัง เข้มงวด</option>
                                        <option value="urgent">⏰ Urgent - เร่งด่วน จำกัดเวลา</option>
                                    </select>
                                    <small class="text-secondary" id="emotion-description">
                                        Select the emotional tone for the voice generation
                                    </small>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Emotion Intensity:</label>
                                    <input type="range" class="form-control" id="emotion-intensity" 
                                        min="0.5" max="2.0" step="0.1" value="1.2">
                                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-secondary);">
                                        <span>Subtle (0.5)</span>
                                        <span id="intensity-value">1.2</span>
                                        <span>Intense (2.0)</span>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Audio Quality:</label>
                                    <select class="form-control" id="mp3-quality-select">
                                        <option value="high">🔊 High Quality (Premium)</option>
                                        <option value="medium" selected>🎵 Medium Quality (Recommended)</option>
                                        <option value="low">📻 Low Quality (Fast)</option>
                                    </select>
                                </div>
                                
                                <div class="alert alert-info">
                                    <strong>📝 Script Preview:</strong><br>
                                    <div style="max-height: 150px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 10px;">
                                        ${formatEmotionalMarkup(script.content)}
                                    </div>
                                    <div style="margin-top: 10px; font-size: 0.9rem;">
                                        <strong>Duration:</strong> ~${script.duration_estimate || 'Unknown'} seconds |
                                        <strong>Words:</strong> ${script.word_count || 0} |
                                        <strong>Target Emotion:</strong> ${script.target_emotion || 'Professional'}
                                    </div>
                                </div>
                                
                                ${providersData.enhanced_tts ? `
                                    <div class="alert alert-success" style="margin-top: 15px;">
                                        <strong>🎭 Enhanced TTS Active!</strong><br>
                                        This system supports emotional voice generation, natural speech patterns, and multiple voice providers.
                                        <br><small>Recommended: Edge TTS for best Thai language support</small>
                                    </div>
                                ` : `
                                    <div class="alert alert-warning" style="margin-top: 15px;">
                                        <strong>📢 Basic TTS Mode</strong><br>
                                        Enhanced emotional TTS is not available. Using fallback mode.
                                    </div>
                                `}
                            </div>
                            <div class="modal-actions">
                                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                                <button class="btn btn-info btn-sm" onclick="testTTSPreview(${scriptId})" style="margin-right: auto;">
                                    <i class="fas fa-play"></i> Preview
                                </button>
                                <button class="btn btn-success" onclick="confirmEnhancedMP3Generation(${scriptId})">
                                    <i class="fas fa-magic"></i> Generate Enhanced MP3
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                window.currentEditingScriptId = scriptId;
                showModal(modal);

                // Setup event listeners
                setupEnhancedTTSEventListeners();

            } catch (error) {
                console.error('Error loading TTS providers:', error);
                // Fallback to basic modal
                showBasicMP3GenerationModal(script);
            }
        }

        function setupEnhancedTTSEventListeners() {
            // Update intensity display
            const intensitySlider = document.getElementById('emotion-intensity');
            const intensityValue = document.getElementById('intensity-value');

            if (intensitySlider && intensityValue) {
                intensitySlider.addEventListener('input', function () {
                    intensityValue.textContent = this.value;
                });
            }

            // Update emotion options based on selected voice
            updateEmotionOptions();
        }

        async function updateEmotionOptions() {
            const voiceSelect = document.getElementById('voice-persona-select');
            const emotionSelect = document.getElementById('emotion-select');
            const emotionDescription = document.getElementById('emotion-description');

            if (!voiceSelect || !emotionSelect) return;

            const selectedOption = voiceSelect.options[voiceSelect.selectedIndex];
            const provider = selectedOption.getAttribute('data-provider');
            const supportedEmotions = JSON.parse(selectedOption.getAttribute('data-emotions') || '[]');

            // Update emotion description
            const providerInfo = {
                'edge': 'Microsoft Edge TTS - รองรับอารมณ์หลากหลายด้วย SSML',
                'elevenlabs': 'ElevenLabs AI - เสียง AI ที่มีอารมณ์ธรรมชาติสูง',
                'azure': 'Azure Cognitive Services - เสียงระดับองค์กร',
                'basic': 'Basic TTS - เสียงพื้นฐาน'
            };

            if (emotionDescription) {
                emotionDescription.textContent = providerInfo[provider] || 'Voice provider information';
            }

            // Update available emotions (keep all options but highlight supported ones)
            const emotionOptions = emotionSelect.querySelectorAll('option');
            emotionOptions.forEach(option => {
                const emotionValue = option.value;
                const isSupported = supportedEmotions.includes(emotionValue);

                if (isSupported) {
                    option.style.background = '#e8f5e8';
                    option.style.fontWeight = 'bold';
                } else {
                    option.style.background = '';
                    option.style.fontWeight = '';
                }
            });
        }

        async function confirmMP3Generation(scriptId) {
            const voicePersonaId = document.getElementById('voice-persona-select').value;
            const quality = document.getElementById('mp3-quality-select').value;

            if (!voicePersonaId) {
                showAlert('Please select a voice persona', 'error');
                return;
            }

            try {
                showAlert('🎵 กำลังสร้าง MP3 ไฟล์...', 'info');
                closeModal();

                const response = await fetch('/api/v1/dashboard/mp3/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        script_ids: [parseInt(scriptId)],
                        voice_persona_id: parseInt(voicePersonaId),
                        quality: quality
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showAlert('✅ MP3 generation started! กำลังประมวลผลในพื้นหลัง...', 'success');

                    // Poll for completion
                    pollMP3Generation(scriptId);

                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to start MP3 generation');
                }

            } catch (error) {
                console.error('Error generating MP3:', error);
                showAlert('Failed to generate MP3: ' + error.message, 'error');
            }
        }

        async function pollMP3Generation(scriptId, attempts = 0) {
            const maxAttempts = 30; // 30 seconds timeout

            if (attempts >= maxAttempts) {
                showAlert('⏱️ MP3 generation is taking longer than expected. Please refresh to check status.', 'warning');
                return;
            }

            try {
                // Check script status
                const response = await fetch(`/api/v1/dashboard/scripts/${scriptId}`);
                if (response.ok) {
                    const script = await response.json();

                    if (script.has_mp3) {
                        showAlert('🎉 MP3 generation completed successfully!', 'success');
                        await loadScripts(); // Reload scripts to show new MP3
                        await loadDashboardStats(); // Update stats
                        return;
                    }
                }

                // Continue polling
                setTimeout(() => pollMP3Generation(scriptId, attempts + 1), 1000);

            } catch (error) {
                console.error('Error polling MP3 status:', error);
                setTimeout(() => pollMP3Generation(scriptId, attempts + 1), 1000);
            }
        }

        async function playMP3(scriptId) {
            try {
                // Check if script has MP3
                const response = await fetch(`/api/v1/dashboard/scripts/${scriptId}`);
                if (!response.ok) {
                    throw new Error('Script not found');
                }

                const script = await response.json();

                if (!script.has_mp3) {
                    showAlert('This script does not have an MP3 file yet.', 'warning');
                    return;
                }

                // For now, show alert with MP3 info
                // In production, you would implement actual audio player
                showAlert(`🎵 MP3 Player coming soon!\n\nScript: ${script.title}\nDuration: ~${script.duration_estimate}s`, 'info');

                // TODO: Implement actual audio player
                // Example of what the audio player would look like:
                /*
                const audioUrl = `/static/audio/script_${scriptId}.mp3`;
                const audio = new Audio(audioUrl);
                audio.play().catch(error => {
                    console.error('Audio playback failed:', error);
                    showAlert('Failed to play audio file', 'error');
                });
                */

            } catch (error) {
                console.error('Error playing MP3:', error);
                showAlert('Error accessing MP3 file: ' + error.message, 'error');
            }
        }



        async function deleteMP3(scriptId) {
            if (!confirm('คุณต้องการลบ MP3 ไฟล์นี้หรือไม่?\n\nการลบจะปลดล็อคการแก้ไขสคริปต์')) {
                return;
            }

            try {
                // First get the script to find MP3 files
                const scriptResponse = await fetch(`/api/v1/dashboard/scripts/${scriptId}`);
                if (!scriptResponse.ok) {
                    throw new Error('Script not found');
                }

                const script = await scriptResponse.json();

                if (!script.has_mp3) {
                    showAlert('This script does not have an MP3 file to delete.', 'warning');
                    return;
                }

                // For now, we'll use a direct endpoint (you'll need to implement this)
                // Since we don't have the MP3 ID directly, we'll use script ID
                const response = await fetch(`/api/v1/dashboard/scripts/${scriptId}/mp3`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const result = await response.json();
                    showAlert('✅ MP3 file deleted successfully! สคริปต์ถูกปลดล็อคแล้ว', 'success');
                    await loadScripts(); // Reload scripts
                    await loadDashboardStats(); // Update stats
                } else {
                    throw new Error('Failed to delete MP3 file');
                }

            } catch (error) {
                console.error('Error deleting MP3:', error);
                showAlert('Failed to delete MP3: ' + error.message, 'error');
            }
        }

        async function showBulkMP3GenerationModal(productId) {
            const productScripts = currentScripts.filter(s => s.product_id === productId && !s.has_mp3);

            if (!productScripts.length) {
                showAlert('No scripts available for MP3 generation. All scripts either have MP3 files or none exist.', 'warning');
                return;
            }

            if (!voicePersonas.length) {
                showAlert('No voice personas available. Please create voice personas first.', 'error');
                return;
            }

            const modal = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>🎵 Bulk MP3 Generation</h3>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Select Scripts:</label>
                                <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; border-radius: 6px;">
                                    ${productScripts.map(script => `
                                        <label style="display: block; margin-bottom: 8px;">
                                            <input type="checkbox" id="script-${script.id}" value="${script.id}" checked style="margin-right: 8px;">
                                            ${escapeHtml(script.title)} (~${script.duration_estimate || 0}s)
                                        </label>
                                    `).join('')}
                                </div>
                                <small class="text-secondary">
                                    <button type="button" class="btn btn-sm btn-secondary" onclick="toggleAllScripts(true)" style="margin-top: 5px; margin-right: 5px;">Select All</button>
                                    <button type="button" class="btn btn-sm btn-secondary" onclick="toggleAllScripts(false)" style="margin-top: 5px;">Deselect All</button>
                                </small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Voice Persona:</label>
                                <select class="form-control" id="bulk-voice-persona-select">
                                    ${voicePersonas.map(persona =>
                `<option value="${persona.id}">${escapeHtml(persona.name)} - ${escapeHtml(persona.description || '')}</option>`
            ).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Quality:</label>
                                <select class="form-control" id="bulk-mp3-quality-select">
                                    <option value="medium">Medium (Recommended)</option>
                                    <option value="high">High Quality</option>
                                    <option value="low">Low (Fast)</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn btn-success" onclick="confirmBulkMP3Generation()">
                                <i class="fas fa-music"></i> Generate All MP3s
                            </button>
                        </div>
                    </div>
                </div>
            `;

            showModal(modal);
        }

        function toggleAllScripts(checked) {
            const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="script-"]');
            checkboxes.forEach(checkbox => checkbox.checked = checked);
        }

        async function confirmBulkMP3Generation() {
            const selectedScriptIds = Array.from(document.querySelectorAll('input[type="checkbox"][id^="script-"]:checked'))
                .map(checkbox => parseInt(checkbox.value));

            const voicePersonaId = document.getElementById('bulk-voice-persona-select').value;
            const quality = document.getElementById('bulk-mp3-quality-select').value;

            if (!selectedScriptIds.length) {
                showAlert('Please select at least one script', 'error');
                return;
            }

            if (!voicePersonaId) {
                showAlert('Please select a voice persona', 'error');
                return;
            }

            try {
                showAlert(`🎵 กำลังสร้าง MP3 สำหรับ ${selectedScriptIds.length} สคริปต์...`, 'info');
                closeModal();

                const response = await fetch('/api/v1/dashboard/mp3/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        script_ids: selectedScriptIds,
                        voice_persona_id: parseInt(voicePersonaId),
                        quality: quality
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showAlert(`✅ Bulk MP3 generation started for ${selectedScriptIds.length} scripts!`, 'success');

                    // Poll for completion of all scripts
                    pollBulkMP3Generation(selectedScriptIds);

                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to start bulk MP3 generation');
                }

            } catch (error) {
                console.error('Error generating bulk MP3:', error);
                showAlert('Failed to generate bulk MP3: ' + error.message, 'error');
            }
        }

        async function pollBulkMP3Generation(scriptIds, attempts = 0) {
            const maxAttempts = 60; // 60 seconds timeout for bulk

            if (attempts >= maxAttempts) {
                showAlert('⏱️ Bulk MP3 generation is taking longer than expected. Please refresh to check status.', 'warning');
                return;
            }

            try {
                // Check all scripts status
                let completedCount = 0;

                for (const scriptId of scriptIds) {
                    const response = await fetch(`/api/v1/dashboard/scripts/${scriptId}`);
                    if (response.ok) {
                        const script = await response.json();
                        if (script.has_mp3) {
                            completedCount++;
                        }
                    }
                }

                if (completedCount === scriptIds.length) {
                    showAlert(`🎉 Bulk MP3 generation completed! สร้าง ${completedCount} ไฟล์สำเร็จ`, 'success');
                    await loadScripts(); // Reload scripts
                    await loadDashboardStats(); // Update stats
                    return;
                } else if (completedCount > 0) {
                    showAlert(`⏳ Processing... ${completedCount}/${scriptIds.length} completed`, 'info');
                }

                // Continue polling
                setTimeout(() => pollBulkMP3Generation(scriptIds, attempts + 1), 2000); // 2 second interval for bulk

            } catch (error) {
                console.error('Error polling bulk MP3 status:', error);
                setTimeout(() => pollBulkMP3Generation(scriptIds, attempts + 1), 2000);
            }
        }

        function showCreateManualScriptModal(productId) {
            showAlert('Manual script creation coming soon!', 'info');
        }

        // Dashboard Stats
        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/v1/dashboard/stats');
                const data = await response.json();

                document.getElementById('total-products').textContent = data.products.total;
                document.getElementById('active-products').textContent = data.products.active;
                document.getElementById('total-scripts').textContent = data.content.scripts;
                document.getElementById('total-mp3s').textContent = data.content.mp3_files;

            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                showAlert('Failed to load dashboard statistics', 'error');
            }
        }

        // Products Management
        async function loadProducts() {
            const categoryFilter = document.getElementById('category-filter')?.value || '';
            const statusFilter = document.getElementById('status-filter')?.value || '';

            try {
                showProductsLoading();

                const params = new URLSearchParams();
                if (categoryFilter) params.append('category', categoryFilter);
                if (statusFilter) params.append('status', statusFilter);

                const response = await fetch(`/api/v1/dashboard/products?${params}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                currentProducts = data.products || [];
                filteredProducts = [...currentProducts];

                displayProducts();

            } catch (error) {
                console.error('Error loading products:', error);
                showAlert('Failed to load products: ' + error.message, 'error');
                showProductsError();
            }
        }

        function showProductsLoading() {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = `
                <div class="loading" style="grid-column: 1/-1;">
                    <i class="fas fa-spinner"></i>
                    <p>Loading products...</p>
                </div>
            `;
        }

        function showProductsError() {
            const grid = document.getElementById('products-grid');
            grid.innerHTML = `
                <div class="text-center" style="grid-column: 1/-1; padding: 40px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--error-color); margin-bottom: 15px;"></i>
                    <h3>Failed to load products</h3>
                    <p>Please check your connection and try again.</p>
                    <button class="btn btn-primary mt-10" onclick="loadProducts()">
                        <i class="fas fa-retry"></i> Retry
                    </button>
                </div>
            `;
        }

        function displayProducts() {
            const grid = document.getElementById('products-grid');

            if (!filteredProducts.length) {
                grid.innerHTML = `
                    <div class="text-center" style="grid-column: 1/-1; padding: 40px;">
                        <i class="fas fa-box" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 15px;"></i>
                        <h3>No products found</h3>
                        <p>Start by adding your first product!</p>
                        <button class="btn btn-primary mt-10" onclick="showCreateProductModal()">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredProducts.map(product => createProductCard(product)).join('');
        }

        function createProductCard(product) {
            return `
                <div class="product-card">
                    <div class="product-header">
                        <div class="product-name">${escapeHtml(product.name)}</div>
                        <div class="product-sku">SKU: ${escapeHtml(product.sku)}</div>
                    </div>
                    <div class="product-info">
                        <div class="product-price">
                            ${product.is_on_sale ?
                    `<span style="text-decoration: line-through; color: #999; font-size: 0.9rem;">฿${(product.original_price || 0).toLocaleString()}</span>
                                ฿${(product.sale_price || 0).toLocaleString()} <span style="color: var(--error-color); font-size: 0.8rem;">(-${product.discount_percentage || 0}%)</span>` :
                    `฿${(product.price || 0).toLocaleString()}`
                }
                        </div>
                        <div class="product-stats">
                            <span><i class="fas fa-script"></i> ${product.total_scripts || 0} scripts</span>
                            <span><i class="fas fa-music"></i> ${product.total_mp3s || 0} MP3s</span>
                            <span><i class="fas fa-video"></i> ${product.total_videos || 0} videos</span>
                        </div>
                        <div>
                            <span class="status-badge ${product.status === 'active' ? 'status-active' : 'status-error'}">${product.status || 'unknown'}</span>
                            ${product.has_content_ready ? '<span class="status-badge status-completed">Live Ready</span>' : ''}
                        </div>
                        ${product.description ? `<p style="margin-top: 10px; font-size: 0.9rem; color: var(--text-secondary);">${escapeHtml(product.description.substring(0, 100))}${product.description.length > 100 ? '...' : ''}</p>` : ''}
                    </div>
                    <div class="product-actions">
                        <button class="btn btn-primary btn-sm" onclick="viewProduct(${product.id})">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn btn-success btn-sm" onclick="showAIScriptGenerationModal(${product.id})">
                            <i class="fas fa-robot"></i> AI Scripts
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="editProduct(${product.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.id}, '${escapeHtml(product.name)}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `;
        }

        function searchProducts() {
            const searchTerm = document.getElementById('search-products').value.toLowerCase();

            if (!searchTerm) {
                filteredProducts = [...currentProducts];
            } else {
                filteredProducts = currentProducts.filter(product =>
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.sku.toLowerCase().includes(searchTerm) ||
                    (product.description && product.description.toLowerCase().includes(searchTerm)) ||
                    (product.category && product.category.toLowerCase().includes(searchTerm)) ||
                    (product.brand && product.brand.toLowerCase().includes(searchTerm))
                );
            }

            displayProducts();
        }

        // Product CRUD Operations
        function showCreateProductModal() {
            const modal = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3><i class="fas fa-plus"></i> Add New Product</h3>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="product-form">
                                <div class="form-group">
                                    <label class="form-label">SKU *</label>
                                    <input type="text" class="form-control" id="product-sku" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Product Name *</label>
                                    <input type="text" class="form-control" id="product-name" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" id="product-description" rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Price *</label>
                                    <input type="number" class="form-control" id="product-price" step="0.01" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Original Price</label>
                                    <input type="number" class="form-control" id="product-original-price" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount %</label>
                                    <input type="number" class="form-control" id="product-discount" min="0" max="100">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Category</label>
                                    <select class="form-control" id="product-category">
                                        <option value="">Select Category</option>
                                        <option value="electronics">Electronics</option>
                                        <option value="fashion">Fashion</option>
                                        <option value="beauty">Beauty</option>
                                        <option value="home">Home & Living</option>
                                        <option value="sports">Sports</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Brand</label>
                                    <input type="text" class="form-control" id="product-brand">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Stock Quantity</label>
                                    <input type="number" class="form-control" id="product-stock" min="0">
                                </div>
                            </form>
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="saveProduct()">
                                <i class="fas fa-save"></i> Save Product
                            </button>
                        </div>
                    </div>
                </div>
            `;

            showModal(modal);
        }

        async function saveProduct() {
            const productData = {
                sku: document.getElementById('product-sku').value,
                name: document.getElementById('product-name').value,
                description: document.getElementById('product-description').value,
                price: parseFloat(document.getElementById('product-price').value),
                original_price: parseFloat(document.getElementById('product-original-price').value) || null,
                discount_percentage: parseInt(document.getElementById('product-discount').value) || 0,
                category: document.getElementById('product-category').value,
                brand: document.getElementById('product-brand').value,
                stock_quantity: parseInt(document.getElementById('product-stock').value) || 0
            };

            // Basic validation
            if (!productData.sku || !productData.name || !productData.price) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }

            try {
                const response = await fetch('/api/v1/dashboard/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(productData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to create product');
                }

                const newProduct = await response.json();

                closeModal();
                showAlert('Product created successfully!', 'success');
                await loadProducts();

            } catch (error) {
                console.error('Error creating product:', error);
                showAlert('Failed to create product: ' + error.message, 'error');
            }
        }

        async function viewProduct(id) {
            try {
                const response = await fetch(`/api/v1/dashboard/products/${id}`);

                if (!response.ok) {
                    throw new Error('Product not found');
                }

                const product = await response.json();

                const modal = `
                    <div class="modal-overlay" onclick="closeModal()">
                        <div class="modal-content" onclick="event.stopPropagation()">
                            <div class="modal-header">
                                <h3><i class="fas fa-eye"></i> Product Details</h3>
                                <button class="modal-close" onclick="closeModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div>
                                        <strong>SKU:</strong> ${escapeHtml(product.sku)}<br>
                                        <strong>Name:</strong> ${escapeHtml(product.name)}<br>
                                        <strong>Category:</strong> ${escapeHtml(product.category || 'N/A')}<br>
                                        <strong>Brand:</strong> ${escapeHtml(product.brand || 'N/A')}<br>
                                        <strong>Status:</strong> <span class="status-badge ${product.status === 'active' ? 'status-active' : 'status-error'}">${product.status}</span>
                                    </div>
                                    <div>
                                        <strong>Price:</strong> ฿${(product.price || 0).toLocaleString()}<br>
                                        ${product.original_price ? `<strong>Original Price:</strong> ฿${product.original_price.toLocaleString()}<br>` : ''}
                                        ${product.discount_percentage ? `<strong>Discount:</strong> ${product.discount_percentage}%<br>` : ''}
                                        <strong>Stock:</strong> ${product.stock_quantity || 0} units<br>
                                    </div>
                                </div>
                                ${product.description ? `<div style="margin-top: 20px;"><strong>Description:</strong><br>${escapeHtml(product.description)}</div>` : ''}
                                <div style="margin-top: 20px;">
                                    <strong>Content Status:</strong><br>
                                    <span><i class="fas fa-script"></i> Scripts: ${product.total_scripts || 0}</span> | 
                                    <span><i class="fas fa-music"></i> MP3s: ${product.total_mp3s || 0}</span> | 
                                    <span><i class="fas fa-video"></i> Videos: ${product.total_videos || 0}</span>
                                </div>
                            </div>
                            <div class="modal-actions">
                                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                                <button class="btn btn-primary" onclick="closeModal(); editProduct(${product.id})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                showModal(modal);

            } catch (error) {
                console.error('Error loading product:', error);
                showAlert('Failed to load product details', 'error');
            }
        }

        function editProduct(id) {
            // Load product data for editing
            loadProductForEdit(id);
        }

        async function loadProductForEdit(id) {
            try {
                const response = await fetch(`/api/v1/dashboard/products/${id}`);

                if (!response.ok) {
                    throw new Error('Product not found');
                }

                const product = await response.json();
                showEditProductModal(product);

            } catch (error) {
                console.error('Error loading product for edit:', error);
                showAlert('Failed to load product for editing', 'error');
            }
        }

        function showEditProductModal(product) {
            const modal = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3><i class="fas fa-edit"></i> Edit Product: ${escapeHtml(product.name)}</h3>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="edit-product-form">
                                <input type="hidden" id="edit-product-id" value="${product.id}">
                                <div class="form-group">
                                    <label class="form-label">SKU *</label>
                                    <input type="text" class="form-control" id="edit-product-sku" value="${escapeHtml(product.sku)}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Product Name *</label>
                                    <input type="text" class="form-control" id="edit-product-name" value="${escapeHtml(product.name)}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" id="edit-product-description" rows="3">${escapeHtml(product.description || '')}</textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Price *</label>
                                    <input type="number" class="form-control" id="edit-product-price" step="0.01" value="${product.price || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Original Price</label>
                                    <input type="number" class="form-control" id="edit-product-original-price" step="0.01" value="${product.original_price || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount %</label>
                                    <input type="number" class="form-control" id="edit-product-discount" min="0" max="100" value="${product.discount_percentage || 0}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Category</label>
                                    <select class="form-control" id="edit-product-category">
                                        <option value="">Select Category</option>
                                        <option value="electronics" ${product.category === 'electronics' ? 'selected' : ''}>Electronics</option>
                                        <option value="fashion" ${product.category === 'fashion' ? 'selected' : ''}>Fashion</option>
                                        <option value="beauty" ${product.category === 'beauty' ? 'selected' : ''}>Beauty</option>
                                        <option value="home" ${product.category === 'home' ? 'selected' : ''}>Home & Living</option>
                                        <option value="sports" ${product.category === 'sports' ? 'selected' : ''}>Sports</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Brand</label>
                                    <input type="text" class="form-control" id="edit-product-brand" value="${escapeHtml(product.brand || '')}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Stock Quantity</label>
                                    <input type="number" class="form-control" id="edit-product-stock" min="0" value="${product.stock_quantity || 0}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Key Features (one per line)</label>
                                    <textarea class="form-control" id="edit-product-features" rows="3" placeholder="Enter key features, one per line">${(product.key_features || []).join('\\n')}</textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Selling Points (one per line)</label>
                                    <textarea class="form-control" id="edit-product-selling-points" rows="3" placeholder="Enter selling points, one per line">${(product.selling_points || []).join('\\n')}</textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Target Audience</label>
                                    <input type="text" class="form-control" id="edit-product-target-audience" value="${escapeHtml(product.target_audience || '')}" placeholder="e.g., Young professionals, Tech enthusiasts">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Promotion Text</label>
                                    <input type="text" class="form-control" id="edit-product-promotion" value="${escapeHtml(product.promotion_text || '')}" placeholder="Special promotion text">
                                </div>
                            </form>
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="updateProduct()">
                                <i class="fas fa-save"></i> Update Product
                            </button>
                        </div>
                    </div>
                </div>
            `;

            showModal(modal);
        }

        async function updateProduct() {
            const productId = document.getElementById('edit-product-id').value;
            const productData = {
                sku: document.getElementById('edit-product-sku').value,
                name: document.getElementById('edit-product-name').value,
                description: document.getElementById('edit-product-description').value,
                price: parseFloat(document.getElementById('edit-product-price').value),
                original_price: parseFloat(document.getElementById('edit-product-original-price').value) || null,
                discount_percentage: parseInt(document.getElementById('edit-product-discount').value) || 0,
                category: document.getElementById('edit-product-category').value,
                brand: document.getElementById('edit-product-brand').value,
                stock_quantity: parseInt(document.getElementById('edit-product-stock').value) || 0,
                key_features: document.getElementById('edit-product-features').value.split('\\n').filter(f => f.trim()),
                selling_points: document.getElementById('edit-product-selling-points').value.split('\\n').filter(f => f.trim()),
                target_audience: document.getElementById('edit-product-target-audience').value,
                promotion_text: document.getElementById('edit-product-promotion').value
            };

            // Basic validation
            if (!productData.sku || !productData.name || !productData.price) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/v1/dashboard/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(productData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to update product');
                }

                const updatedProduct = await response.json();

                closeModal();
                showAlert('Product updated successfully!', 'success');
                await loadProducts();

            } catch (error) {
                console.error('Error updating product:', error);
                showAlert('Failed to update product: ' + error.message, 'error');
            }
        }

        async function deleteProduct(id, name) {
            if (!confirm(`Are you sure you want to delete "${name}"?\n\nThis will also delete all related scripts, MP3s, and videos.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/v1/dashboard/products/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete product');
                }

                showAlert('Product deleted successfully!', 'success');
                await loadProducts();
                await loadDashboardStats();

            } catch (error) {
                console.error('Error deleting product:', error);
                showAlert('Failed to delete product: ' + error.message, 'error');
            }
        }

        // Utility Functions
        function showModal(content) {
            document.getElementById('modal-container').innerHTML = content;
        }

        function closeModal() {
            document.getElementById('modal-container').innerHTML = '';
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alertClass = type === 'error' ? 'alert-error' : type === 'success' ? 'alert-success' : 'alert-info';

            const alert = document.createElement('div');
            alert.className = `alert ${alertClass}`;
            alert.innerHTML = `
                ${message}
                <button style="float: right; background: none; border: none; font-size: 1.2rem; cursor: pointer;" onclick="this.parentElement.remove()">&times;</button>
            `;

            alertContainer.appendChild(alert);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.remove();
                }
            }, 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Backwards compatibility function
        async function generateAIScripts(productId) {
            showAIScriptGenerationModal(productId);
        }

        async function refreshDashboard() {
            await initializeDashboard();
            showAlert('Dashboard refreshed successfully!', 'success');
        }

        async function confirmEnhancedMP3Generation(scriptId) {
            // ตรวจสอบว่ามี script ที่เลือกไว้หรือไม่
            if (!scriptId) {
                alert('ไม่พบข้อมูล script ที่ต้องการสร้าง MP3');
                return;
            }

            const voicePersonaSelect = document.getElementById('voice-persona-select');
            const emotionSelect = document.getElementById('emotion-select');
            const qualitySelect = document.getElementById('mp3-quality-select');
            const intensitySlider = document.getElementById('emotion-intensity');

            // ตรวจสอบว่ามี voice persona ที่เลือกไว้หรือไม่
            if (!voicePersonaSelect || !voicePersonaSelect.value) {
                alert('กรุณาเลือก Voice Persona');
                return;
            }


            const currentScript = currentScripts.find(s => s.id === scriptId);
            const scriptTitle = currentScript ? currentScript.title : 'Script';

            // แสดง confirmation dialog
            const confirm = window.confirm(
                `ต้องการสร้าง Enhanced MP3 สำหรับ "${scriptTitle}" หรือไม่?\n\n` +
                `Voice: ${voicePersonaSelect.selectedOptions[0].text}\n` +
                `Emotion: ${emotionSelect.value}\n` +
                `Quality: ${qualitySelect.value}`
            );

            if (confirm) {
                try {
                    closeModal();
                    // เรียก function สร้าง MP3 พร้อม parameters ที่ครบถ้วน
                    await generateEnhancedMP3WithSettings(scriptId, {
                        voicePersonaId: parseInt(voicePersonaSelect.value),
                        emotion: emotionSelect.value,
                        intensity: parseFloat(intensitySlider.value),
                        quality: qualitySelect.value
                    });
                } catch (error) {
                    console.error('Enhanced MP3 generation error:', error);
                    alert('เกิดข้อผิดพลาดในการสร้าง MP3: ' + error.message);
                }
            }
        }

        async function generateEnhancedMP3WithSettings(scriptId, settings) {
            try {
                showAlert('🎵 กำลังสร้าง Enhanced MP3 พร้อม emotional settings...', 'info');

                const response = await fetch('/api/v1/dashboard/mp3/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        script_ids: [scriptId],
                        voice_persona_id: settings.voicePersonaId,
                        quality: 'enhanced',
                        emotion: settings.emotion,
                        intensity: settings.intensity
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showAlert('✅ Enhanced MP3 generation started! กำลังประมวลผลในพื้นหลัง...', 'success');

                    // Poll for completion
                    pollMP3Generation(scriptId);
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to start Enhanced MP3 generation');
                }

            } catch (error) {
                console.error('Error generating Enhanced MP3:', error);
                showAlert('Failed to generate Enhanced MP3: ' + error.message, 'error');
            }
        }

        function getCurrentScriptIdFromModal() {
            // วิธีที่ 1: ดึงจาก data attribute ของ modal
            const modal = document.querySelector('.modal[style*="block"]'); // modal ที่เปิดอยู่
            if (modal) {
                const scriptId = modal.dataset.scriptId;
                if (scriptId) return parseInt(scriptId);
            }

            // วิธีที่ 2: ดึงจาก element ที่มี script-id
            const scriptElement = document.querySelector('[data-current-script-id]');
            if (scriptElement) {
                return parseInt(scriptElement.dataset.currentScriptId);
            }

            // วิธีที่ 3: ดึงจาก global variable (ถ้ามี)
            if (window.currentScriptId) {
                return parseInt(window.currentScriptId);
            }

            // วิธีที่ 4: ดึงจาก URL หรือ form hidden field
            const hiddenInput = document.querySelector('input[name="script_id"]');
            if (hiddenInput && hiddenInput.value) {
                return parseInt(hiddenInput.value);
            }

            return null;
        }

        async function generateEnhancedMP3(scriptIds, voicePersonaId) {
            // แสดง loading
            showLoadingState('กำลังสร้าง Enhanced MP3...');

            try {
                const response = await fetch('/api/v1/dashboard/mp3/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        script_ids: scriptIds,
                        voice_persona_id: parseInt(voicePersonaId),
                        quality: 'enhanced'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`เริ่มสร้าง Enhanced MP3 แล้ว!\n\nจำนวน: ${data.scripts.length} scripts\nเสียง: ${data.voice_persona.name}`);

                    // รีเฟรช script list
                    loadProductScripts(currentProductId);
                } else {
                    throw new Error(data.detail || 'Unknown error');
                }

            } catch (error) {
                console.error('Enhanced MP3 generation error:', error);
                alert('เกิดข้อผิดพลาด: ' + error.message);
            } finally {
                hideLoadingState();
            }
        }

        function getSelectedScripts() {
            // ดึง scripts ที่ถูกเลือก (checkboxes)
            const checkboxes = document.querySelectorAll('input[type="checkbox"][data-script-id]:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.dataset.scriptId));
        }

        function showLoadingState(message) {
            // แสดง loading indicator
            const loadingDiv = document.getElementById('loadingIndicator');
            if (loadingDiv) {
                loadingDiv.textContent = message;
                loadingDiv.style.display = 'block';
            }
        }

        function hideLoadingState() {
            // ซ่อน loading indicator
            const loadingDiv = document.getElementById('loadingIndicator');
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }
        }


    </script>
</body>

</html>